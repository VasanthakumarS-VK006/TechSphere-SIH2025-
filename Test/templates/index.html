<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAMASTE-ICD-11 Terminology Service</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        #suggestions { max-height: 200px; overflow-y: auto; }
        #results, #bundle-output { white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">NAMASTE-ICD-11 Terminology Service</h1>
        <div class="mb-3">
            <label for="searchInput" class="form-label">Search NAMC Terms (Code, English, or Siddha):</label>
            <input type="text" id="searchInput" class="form-control" placeholder="e.g., Jaundice, AB, Mañcaḷ Nōy" autocomplete="off">
            <ul id="suggestions" class="list-group mt-2"></ul>
        </div>
        <button id="translateBtn" class="btn btn-primary mb-3" disabled>Translate to ICD-11</button>
        <button id="createBundleBtn" class="btn btn-success mb-3" disabled>Create FHIR ProblemList</button>
        <div id="results" class="alert alert-info" style="display: none;"></div>
        <div id="bundle-output" class="alert alert-success" style="display: none;"></div>
    </div>

    <script>
        const searchInput = document.getElementById('searchInput');
        const suggestionsList = document.getElementById('suggestions');
        const translateBtn = document.getElementById('translateBtn');
        const createBundleBtn = document.getElementById('createBundleBtn');
        const resultsDiv = document.getElementById('results');
        const bundleOutputDiv = document.getElementById('bundle-output');
        let selectedTerm = null;

        // Auto-complete search
        searchInput.addEventListener('input', async () => {
            const query = searchInput.value.trim();
            suggestionsList.innerHTML = '';
            translateBtn.disabled = true;
            createBundleBtn.disabled = true;
            resultsDiv.style.display = 'none';
            bundleOutputDiv.style.display = 'none';

            if (query.length < 2) return;

            try {
                const response = await fetch(`/api/suggestions?filter=${encodeURIComponent(query)}`);
                const data = await response.json();
                const suggestions = data.parameter[0].resource.expansion.contains || [];
                suggestions.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `${item.code}: ${item.display} (${item.designation?.[0]?.value || ''})`;
                    li.onclick = () => {
                        selectedTerm = item;
                        searchInput.value = item.display;
                        suggestionsList.innerHTML = '';
                        translateBtn.disabled = false;
                        createBundleBtn.disabled = false;
                    };
                    suggestionsList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching suggestions:', error);
            }
        });

        // Translate to ICD-11
        translateBtn.addEventListener('click', async () => {
            if (!selectedTerm) return;
            try {
                const response = await fetch('/ConceptMap/$translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: selectedTerm.code,
                        system: 'https://ndhm.gov.in/fhir/CodeSystem/namc',
                        targetsystem: 'http://id.who.int/icd/release/11/mms',
                        meta: { security: [{ system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode', code: 'CONSENT' }] }
                    })
                });
                const data = await response.json();
                if (data.resourceType === 'OperationOutcome') {
                    resultsDiv.textContent = 'No ICD-11 mappings found.';
                } else {
                    const matches = data.parameter.map(p => p.valueCodeableConcept.coding[0]);
                    resultsDiv.textContent = JSON.stringify(matches, null, 2);
                }
                resultsDiv.style.display = 'block';
            } catch (error) {
                resultsDiv.textContent = 'Error during translation: ' + error.message;
                resultsDiv.style.display = 'block';
            }
        });

        // Create FHIR Bundle with ProblemList
        createBundleBtn.addEventListener('click', async () => {
            if (!selectedTerm) return;
            try {
                const response = await fetch('/ConceptMap/$translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: selectedTerm.code,
                        system: 'https://ndhm.gov.in/fhir/CodeSystem/namc',
                        targetsystem: 'http://id.who.int/icd/release/11/mms',
                        meta: { security: [{ system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode', code: 'CONSENT' }] }
                    })
                });
                const data = await response.json();
                if (data.resourceType === 'OperationOutcome') throw new Error('No mappings found');

                const codings = [
                    { system: 'https://ndhm.gov.in/fhir/CodeSystem/namc', code: selectedTerm.code, display: selectedTerm.display },
                    ...data.parameter.map(p => p.valueCodeableConcept.coding[0])
                ];

                const bundle = {
                    resourceType: 'Bundle',
                    type: 'collection',
                    entry: [{
                        resource: {
                            resourceType: 'Condition',
                            code: { coding: codings },
                            subject: { reference: 'Patient/example' },
                            meta: { security: [{ system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode', code: 'CONSENT' }] }
                        }
                    }]
                };

                const uploadResponse = await fetch('/Bundle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bundle)
                });
                const uploadedBundle = await uploadResponse.json();
                bundleOutputDiv.textContent = JSON.stringify(uploadedBundle, null, 2);
                bundleOutputDiv.style.display = 'block';
            } catch (error) {
                bundleOutputDiv.textContent = 'Error creating Bundle: ' + error.message;
                bundleOutputDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>
